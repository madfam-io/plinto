{{- if .Values.backup.enabled }}
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ include "janua.fullname" . }}-backup
  labels:
    {{- include "janua.labels" . | nindent 4 }}
    app.kubernetes.io/component: backup
spec:
  schedule: {{ .Values.backup.schedule | quote }}
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            {{- include "janua.selectorLabels" . | nindent 12 }}
            app.kubernetes.io/component: backup
        spec:
          restartPolicy: OnFailure
          {{- with .Values.imagePullSecrets }}
          imagePullSecrets:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          serviceAccountName: {{ include "janua.serviceAccountName" . }}
          securityContext:
            {{- toYaml .Values.podSecurityContext | nindent 12 }}
          containers:
            - name: backup
              image: postgres:15-alpine
              imagePullPolicy: IfNotPresent
              command:
                - /bin/sh
                - -c
                - |
                  set -e
                  echo "Starting backup at $(date)"
                  
                  # Create backup
                  BACKUP_FILE="/tmp/backup-$(date +%Y%m%d-%H%M%S).sql.gz"
                  PGPASSWORD=$POSTGRES_PASSWORD pg_dump \
                    -h {{ include "janua.fullname" . }}-postgresql \
                    -U {{ .Values.postgresql.auth.username }} \
                    -d {{ .Values.postgresql.auth.database }} \
                    --no-owner \
                    --no-acl \
                    | gzip > $BACKUP_FILE
                  
                  echo "Backup created: $BACKUP_FILE"
                  
                  # Upload to S3
                  if [ -n "$S3_BUCKET" ]; then
                    echo "Uploading to S3..."
                    aws s3 cp $BACKUP_FILE s3://$S3_BUCKET/backups/
                    echo "Upload complete"
                  fi
                  
                  # Clean up old backups
                  if [ -n "$RETENTION_DAYS" ]; then
                    echo "Cleaning up backups older than $RETENTION_DAYS days..."
                    aws s3 ls s3://$S3_BUCKET/backups/ | \
                      awk '{print $4}' | \
                      while read file; do
                        FILE_DATE=$(echo $file | grep -oE '[0-9]{8}')
                        if [ -n "$FILE_DATE" ]; then
                          FILE_AGE=$(($(date +%s) - $(date -d $FILE_DATE +%s)))
                          MAX_AGE=$((RETENTION_DAYS * 86400))
                          if [ $FILE_AGE -gt $MAX_AGE ]; then
                            aws s3 rm s3://$S3_BUCKET/backups/$file
                            echo "Deleted old backup: $file"
                          fi
                        fi
                      done
                  fi
                  
                  echo "Backup completed at $(date)"
              env:
                - name: POSTGRES_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: {{ include "janua.fullname" . }}-secret
                      key: database-password
                - name: S3_BUCKET
                  value: {{ .Values.backup.storage.bucket }}
                - name: AWS_REGION
                  value: {{ .Values.backup.storage.region }}
                - name: AWS_ACCESS_KEY_ID
                  valueFrom:
                    secretKeyRef:
                      name: {{ include "janua.fullname" . }}-secret
                      key: backup-access-key
                - name: AWS_SECRET_ACCESS_KEY
                  valueFrom:
                    secretKeyRef:
                      name: {{ include "janua.fullname" . }}-secret
                      key: backup-secret-key
                - name: RETENTION_DAYS
                  value: {{ .Values.backup.retention | quote }}
              resources:
                requests:
                  memory: "256Mi"
                  cpu: "100m"
                limits:
                  memory: "512Mi"
                  cpu: "500m"
{{- end }}